---
- name: Install notify.sh
  ansible.builtin.import_role: { name: notify-sh }
  vars:   # noqa: var-naming[no-role-prefix]
    notify_sh_prereqs: true

- name: Privileged
  become: true
  vars:
    script_home: /opt/varlog/ssh-alert
    script_path: "{{ script_home }}/notify.sh"
    secret_path: "{{ script_home }}/notify._secret_.sh"
  block:
    - name: Create home directory
      ansible.builtin.file:
        path: "{{ script_home }}"
        state: directory
        mode: '0755'

    - name: Create notify.sh script
      ansible.builtin.template:
        src: notify.sh.j2
        dest: "{{ script_path }}"
        mode: '0755'

    - name: Create notify secret
      ansible.builtin.template:
        src: notify._secret_.sh.j2
        dest: "{{ secret_path }}"
        mode: '0600'

    - name: Test installation
      ansible.builtin.command:
        cmd: "{{ script_path }} {{ ssh_alert_test_flag }} -t 'SSH test' -- 'Alert test'"
      register: ssh_alert_test
      changed_when: false

    - name: Add to pam.d/ssh
      ansible.builtin.blockinfile:
        path: /etc/pam.d/sshd
        marker: "# {mark} ssh-alert"
        block: session required pam_exec.so {{ script_path }}
      when: ssh_alert_test.rc < 1
