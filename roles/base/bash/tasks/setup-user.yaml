---
- name: Setup user shell
  ansible.builtin.command: chsh -s /bin/bash {{ user }}
  changed_when: getent_passwd[user].5 != '/bin/bash'
  register: bash_user_state
  become: true

- name: Reload users database
  # noqa: no-handler
  ansible.builtin.getent:
    database: passwd
  when: bash_user_state.changed

- name: Mark user done
  ansible.builtin.set_fact:
    bash_users_done: "{{ (bash_users_done | default([])) + [user] }}"
