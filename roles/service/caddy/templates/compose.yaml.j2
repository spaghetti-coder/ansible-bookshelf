{% set version = (caddy_version | default(bookshelf_const_version.caddy, true)) %}
{% set http_port = caddy_http_port | default(-1, true) | int %}
{% set https_port = caddy_https_port | default(-1, true) | int %}
{% set data_volumes = (caddy_user == caddy_owner)
    | ternary(caddy_data_volumes, data_volumes_abs) | default([], true) %}
---
services:
  app:
    build:
      context: ./docker
      dockerfile: ./docker/Dockerfile
    image: caddy:bookshelf-{{ version }}
    container_name: "{{ caddy_service_name }}"
    restart: unless-stopped
    volumes:
{% for volume in data_volumes %}
      - '{{ volume }}'
{% endfor %}
      - "{{ conf_dir }}/config:/config"
      - "{{ conf_dir }}/config:/data"
    user: "{{ user_uid }}:{{ user_gid }}"

# TAILSCALE HERE

    hostname: "{{ nginx_proxy_hostname }}"
{% if (http_port > -1) or (https_port > -1) %}
    ports:
{% if http_port > -1 %}
      - "{{ http_port }}:80"
{% endif %}
{% if https_port > -1 %}
      - "{{ https_port }}:443"
{% endif %}
{% endif %}{# http_port or https_port #}

networks:
  "{{ nginx_proxy_net }}":
    name: "{{ nginx_proxy_net }}"
