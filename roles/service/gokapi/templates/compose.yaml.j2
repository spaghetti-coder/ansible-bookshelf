{% set version = gokapi_version | default(bookshelf_const_version.gokapi, true) %}
{% set web_ui_port = gokapi_web_ui_port | default(bookshelf_const_port.gokapi.web_ui, true) %}
{% set tailscale_version = gokapi_ts_version | default(bookshelf_const_version.gokapi_tailscale, true) %}
---
x-tailscale: &tailscale
  # https://hub.docker.com/r/tailscale/tailscale/tags
  image: tailscale/tailscale:{{ tailscale_version }}
  container_name: {{ gokapi_ts_service_name }}
  restart: unless-stopped
  env_file: &env_files
    - ./secret.env
    - ./main.env
  volumes:
    - '{{ conf_dir }}/tailscale:/var/lib/tailscale'
    # Demo: https://github.com/tailscale-dev/video-code-snippets/blob/main/2025-06-mealie/serve.json
    - ./ts-serve.json:/config/serve.json
  devices:
    - /dev/net/tun:/dev/net/tun
  cap_add:
    - NET_ADMIN
    - SYS_MODULE
  healthcheck:  # Check Tailscale has a Tailnet IP and is operational
    test: ["CMD", "wget", "--spider", "-q", "http://{{ gokapi_ts_local_addr_port }}/healthz"]
    interval: 1m
    timeout: 10s
    retries: 3
    start_period: 10s

services:
  app:
    # https://hub.docker.com/r/f0rc3/gokapi/tags
    image: f0rc3/gokapi:{{ version }}
    container_name: {{ gokapi_service_name }}
    restart: unless-stopped
    env_file: *env_files
    user: "{{ user_uid }}:{{ user_gid }}"
    volumes:
      - '{{ conf_dir }}/config:/app/config'
      - '{{ conf_dir }}/data:/app/data'
{% if gokapi_tailscaled %}
    network_mode: "service:tailscale"
    depends_on:
      tailscale: { "condition": "service_healthy" }

  tailscale:
    <<: *tailscale
{% endif %}{# gokapi_tailscaled #}
    hostname: {{ gokapi_hostname }}
{% if gokapi_web_ui_ports_exposed %}
    ports:
      - "{{ web_ui_port }}:{{ gokapi_web_ui_port_int }}"
{% else %}
    # ports:
    #   - "{{ web_ui_port }}:{{ gokapi_web_ui_port_int }}"
{% endif %}{# gokapi_web_ui_ports_exposed #}
{% if not (nginx_proxy_enabled | default(false)) %}
    network_mode: bridge
{% else %}
    networks:
      - {{ nginx_proxy_net }}
    environment:
      - VIRTUAL_HOST={{ gokapi_vhost }}
      - VIRTUAL_PORT={{ gokapi_web_ui_port_int }}

networks:
  {{ nginx_proxy_net }}:
    external: true
{% endif %}{# nginx_proxy_enabled #}
