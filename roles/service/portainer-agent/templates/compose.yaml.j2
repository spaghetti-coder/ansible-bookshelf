{% set version = (portainer_agent_version | default(bookshelf_const_version.portainer_agent, true)) %}
{% set tcp_port = (portainer_agent_tcp_port | default(bookshelf_const_port.portainer_agent.tcp_port, true)) %}
---
# Tutorials:
# * https://www.youtube.com/watch?v=iX0HbrfRyvc

{{ lookup('template', './../../tailscale/partial/sidecar-compose.yaml.j2', template_vars=dict(
  ts_version = portainer_agent_ts_version | default(bookshelf_const_version.portainer_agent_tailscale, true),
  ts_name = portainer_agent_ts_service_name, ts_conf_dir = conf_dir + '/tailscale'
)) }}

services:
  app:
    # https://hub.docker.com/r/portainer/agent/tags?name=alpine
    image: portainer/agent:{{ version }}
    container_name: {{ portainer_agent_service_name }}
    restart: unless-stopped
    env_file:
      - ./secret.env
      - ./main.env
    volumes:
      - '/var/lib/docker/volumes:/var/lib/docker/volumes'
      - '/var/run/docker.sock:/var/run/docker.sock'
{% if portainer_agent_host_management %}
      - '/:/host'
{% endif %}
{% if portainer_agent_tailscaled %}
    network_mode: "service:tailscale"

  tailscale:
    <<: *tailscale
{% endif %}{# portainer_agent_tailscaled #}
    hostname: {{ portainer_agent_hostname }}
{% if tcp_port | int > -1 %}
    ports:
      - '{{ tcp_port }}:{{ portainer_agent_web_ui_port_int }}'
{% endif %}
    network_mode: bridge  # <- Avoid compose default network creation
